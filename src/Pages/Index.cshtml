@page
@using ContosoCrafts.WebSite.Components
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}

<div class="header-container">
    <form method="get" id="searchForm" class="search-bar-container">

        <!-- Centered Welcome Message -->
        <div class="text-center mt-4" style="margin-bottom: 0;">
            <h1 style="font-family: 'Bangers', cursive; font-size: 2.0rem; color: yellow; margin-bottom: 0;">
                Welcome to the Avengers Encyclopedia!
            </h1>
            <p style="font-size: 1.25rem; color: white; margin-bottom: 0;">
                Welcome to the Marvel Encyclopedia, where you can dive into the world of Earth's mightiest heroes. Explore characters, battle them, and rank your favorites.<br />
                <strong>For the full experience, hit play on the Marvel Theme Music below!</strong>
            </p>
        </div>

        <!-- Centered Music Player with Label -->
        <div class="w-100 d-flex align-items-center justify-content-center" style="margin-top: 0; margin-bottom: 1.5rem; padding: 0 0.5rem;">
            <span style="font-family: 'Bangers', cursive; color: yellow; font-size: 1.5rem; margin-right: 10px;">
                Marvel Theme Music:
            </span>
            <button onclick="openMusicPlayer()" class="btn btn-warning mt-2">
                🎵 Play in New Music
            </button>
        </div>

        <div class="homepage-left-controls">
            <div class="homepage-sort-input-group">
                <input type="text" name="SearchTerm" placeholder="Search by Name..."
                       value="@Request.Query["SearchTerm"]"
                       class="search-input" />
                <button type="submit" class="search-btn">Search</button>
            </div>

            <div class="homepage-sort-input-group">
                <select name="SortField" id="SortFieldDropdown" class="homepage-sort-dropdown">
                    <option value="Title" selected="@("Title" == Request.Query["SortField"])">Sort by Name</option>
                    <option value="Intelligence" selected="@("Intelligence" == Request.Query["SortField"])">Sort by Intelligence</option>
                    <option value="Strength" selected="@("Strength" == Request.Query["SortField"])">Sort by Strength</option>
                    <option value="Speed" selected="@("Speed" == Request.Query["SortField"])">Sort by Speed</option>
                    <option value="Durability" selected="@("Durability" == Request.Query["SortField"])">Sort by Durability</option>
                    <option value="Power" selected="@("Power" == Request.Query["SortField"])">Sort by Power</option>
                    <option value="Combat" selected="@("Combat" == Request.Query["SortField"])">Sort by Combat</option>
                </select>

                @{
                    var sortField = Request.Query["SortField"].ToString();
                    var sortOrder = Request.Query["SortOrder"].ToString();
                    var defaultSortOrder = string.IsNullOrEmpty(sortOrder)
                    ? (sortField == "Title" || string.IsNullOrEmpty(sortField) ? "asc" : "desc")
                    : sortOrder;
                }

                <input type="hidden" name="SortOrder" id="SortOrderInput" value="@defaultSortOrder" />

                <div class="homepage-sort-order-buttons">
                    <button type="button"
                            class="homepage-sort-arrow @(Request.Query["SortOrder"] == "desc" ? "selected" : "")"
                            onclick="setSortOrder('desc')">
                        ↓
                    </button>
                    <button type="button"
                            class="homepage-sort-arrow @(Request.Query["SortOrder"] != "desc" ? "selected" : "")"
                            onclick="setSortOrder('asc')">
                        ↑
                    </button>
                </div>
            </div>
        </div>

        <div class="homepage-sort-button-group">
            <button type="button" class="btn btn-terciary" onclick="openFilterSidebar()">Filter</button>
            <button type="button" class="btn btn-secondary" onclick="clearAll()">Clear All</button>
        </div>

        @foreach (var category in new[] { "Alignment", "Role", "Gender" })
        {
            foreach (var value in Request.Query[category])
            {
                <input type="hidden" name="@category" value="@value" />
            }
        }

        @foreach (var stat in new[] { "Intelligence", "Strength", "Speed", "Durability", "Power", "Combat" })
        {
            <input type="hidden" name="@($"{stat}Min")" value="@Request.Query[$"{stat}Min"].FirstOrDefault() ?? " 1"" />
            <input type="hidden" name="@($"{stat}Max")" value="@Request.Query[$"{stat}Max"].FirstOrDefault() ?? " 100"" />
        }
    </form>
</div>

@if (Request.Query.Count > 0)
{
    if (Model.FilteredHeroes.Count == 1)
    {
        <p class="hero-text hero-subtext">
            <span class="numbers">@Model.FilteredHeroes.Count</span> superhero found
        </p>
    }
    else if (Model.FilteredHeroes.Count > 1)
    {
        <p class="hero-text hero-subtext">
            <span class="numbers">@Model.FilteredHeroes.Count superheroes found</span>
        </p>
    }
    else
    {
        <p class="hero-text hero-subtext">No superheroes found</p>
    }
}

@(await Html.RenderComponentAsync<ProductList>(RenderMode.ServerPrerendered, new { Products = Model.FilteredHeroes }))

<!-- Sidebar filter menu (hidden by default) -->
<div id="filterSidebar" class="sidebar">
    <div class="sidebar-header">
        <h4>Filter by:</h4>
        <span class="close-btn" onclick="closeSidebar()">×</span>
    </div>

    <!-- Filter form -->
    <div class="sidebar-content">
        <form method="get" id="filterForm">
            @foreach (var category in new[] { "Alignment", "Role", "Gender" })
            {
                <div class="filter-group">
                    <strong>@category</strong>
                    <div class="filter-options">
                        @foreach (var value in Model.GetValuesForCategory(category))
                        {
                            <label>
                                <input type="checkbox" name="@category" value="@value"
                                @(Request.Query[category].Contains(value) ? "checked" : "") />
                                @value
                            </label>
                        }
                    </div>
                </div>
            }

            <!-- Powerstats sliders -->
            <div class="filter-group">
                <strong>Powerstats</strong>
                @foreach (var stat in new[] { "Intelligence", "Strength", "Speed", "Durability", "Power", "Combat" })
                {
                    <div class="stat-slider">
                        <label class="stat-slider-label">@stat: </label>

                        <div class="slider-container">
                            <span class="slider-container-value min-value">@(Request.Query[$"{stat}Min"].FirstOrDefault() ?? "1")</span>

                            <md-slider min="1"
                                       max="100"
                                       value-start="@Request.Query[$"{stat}Min"].FirstOrDefault() ?? " 1""
                                       value-end="@Request.Query[$"{stat}Max"].FirstOrDefault() ?? " 100""
                                       data-stat="@stat"
                                       range>
                            </md-slider>
                            <span class="slider-container-value max-value">@(Request.Query[$"{stat}Max"].FirstOrDefault() ?? "100")</span>
                        </div>

                        <input type="hidden" name="@(stat)Min" id="@(stat)Min" value="@(Request.Query[$"{stat}Min"].FirstOrDefault() ?? "1")" />
                        <input type="hidden" name="@(stat)Max" id="@(stat)Max" value="@(Request.Query[$"{stat}Max"].FirstOrDefault() ?? "100")" />

                    </div>
                }
            </div>

            <input type="hidden" name="SearchTerm" value="@Request.Query["SearchTerm"]" />
            <button type="submit" class="btn btn-filter-confirm">Apply Filter</button>
            <button type="button" class="btn btn-filter-clear" onclick="clearFilter()">Clear Filters</button>
        </form>
    </div>
</div>


<script src="_framework/blazor.server.js"></script>
<script>
    /// <summary>
    /// Handles setting the sort order based on button click.
    /// </summary>
     function setSortOrder(order)
    {
        // Input element that stores the sort order
        const input = document.getElementById('SortOrderInput');
        input.value = order;
        document.getElementById('searchForm').submit();
    }

    /// <summary>
    /// Adds event listener to the sort field dropdown to update sort order on change.
    /// </summary>
    document.getElementById("SortFieldDropdown").addEventListener("change", function () {
        // Selected field from dropdown
        const selectedField = this.value;

        // Input element for sort order
        const sortOrderInput = document.getElementById("SortOrderInput");

        // Set default sort order
        if (selectedField === "Title")
        {
            sortOrderInput.value = "asc";
        }
        else
        {
            sortOrderInput.value = "desc";
        }

        // Submit the form
        document.getElementById("searchForm").submit();
    });

    /// <summary>
    /// Opens the filter sidebar and initializes sliders
    /// </summary>
    function openFilterSidebar()
    {
        document.getElementById("filterSidebar").classList.add("show");
        setupSliders();
    }

    /// <summary>
    /// Closes the filter sidebar
    /// </summary>
    function closeSidebar()
    {
        document.getElementById("filterSidebar").classList.remove("show");
    }

    /// <summary>
    /// Clears all checkbox filters, resets sliders to defaults, and submits the filter form
    /// </summary>
    function clearFilter()
    {
        // Unchecks the filers
        document.querySelectorAll('input[type="checkbox"]').forEach(function(cb)
        {
            cb.checked = false;
        });

        // Slider components in Filter sidebar
        var sliders = document.querySelectorAll('md-slider');
        sliders.forEach(function(slider)
        {
            slider.valueStart = 1;
            slider.valueEnd = 100;

            // The name of the statistic, as defined in the slider’s data-stat attribute
            const statName = slider.getAttribute('data-stat');

            // The nearest parent element with the 'stat-slider' class
            const container = slider.closest('.stat-slider');

            // The element displaying the minimum value for this stat
            const minValue = container.querySelector('.min-value');

            // The element displaying the maximum value for this stat
            const maxValue = container.querySelector('.max-value');

            // The hidden input field used to store the slider’s minimum value on form submit
            const minInput = document.getElementById(`${statName}Min`);

             // The hidden input field used to store the slider’s maximum value on form submit
            const maxInput = document.getElementById(`${statName}Max`);

            minValue.textContent = '1';
            maxValue.textContent = '100';

            if (minInput)
            {
                minInput.value = '1';
            }

            if (maxInput)
            {
                maxInput.value = '100';
            }
        });

        // Submit the filter form
        document.getElementById('filterForm').submit();
    }

    /// <summary>
    /// Clears the search input, unchecks filters, resets sliders, and reloads the page
    /// </summary>
    function clearAll()
    {
        // Clear search term
        document.querySelector('input[name="SearchTerm"]').value = '';

        // Unchecks the filters
        document.querySelectorAll('input[type="checkbox"]').forEach(function(cb)
        {
            cb.checked = false;
        });

        // Slider components in Filter sidebar
        var sliders = document.querySelectorAll('md-slider');
        sliders.forEach(function(slider)
        {
            slider.valueStart = 1;
            slider.valueEnd = 100;

            // The name of the statistic, as defined in the slider’s data-stat attribute
            const statName = slider.getAttribute('data-stat');

            // The nearest parent element with the 'stat-slider' class
            const container = slider.closest('.stat-slider');

            // The element displaying the minimum value for this stat
            const minValue = container.querySelector('.min-value');

            // The element displaying the maximum value for this stat
            const maxValue = container.querySelector('.max-value');

            // The hidden input field used to store the slider’s minimum value on form submit
            const minInput = document.getElementById(`${statName}Min`);

            // The hidden input field used to store the slider’s maximum value on form submit
            const maxInput = document.getElementById(`${statName}Max`);

            minValue.textContent = '1';
            maxValue.textContent = '100';

           if (minInput)
            {
                minInput.value = '1';
            }

            if (maxInput)
            {
                maxInput.value = '100';
            }
        });

        // Reload page
        window.location.href = window.location.pathname;
    }


    /// <summary>
    /// Configures each slider’s start/end values and attaches input listeners
    /// to keep displayed values and hidden inputs in sync.
    /// </summary>
    function setupSliders()
    {
        // Slider components in Filter sidebar
        var sliders = document.querySelectorAll('md-slider');

        sliders.forEach(function(slider)
        {
            // The name of the statistic, as defined in the slider’s data-stat attribute
            const statName = slider.getAttribute('data-stat');

            // The nearest parent element with the 'stat-slider' class
            const container = slider.closest('.stat-slider');

            // The element displaying the minimum value for this stat
            const minValue = container.querySelector('.min-value');

            // The element displaying the maximum value for this stat
            const maxValue = container.querySelector('.max-value');

            // The hidden input field used to store the slider’s minimum value on form submit
            const minInput = document.getElementById(`${statName}Min`);

            // The hidden input field used to store the slider’s maximum value on form submit
            const maxInput = document.getElementById(`${statName}Max`);

            if (minInput && maxInput)
            {
                slider.valueStart = parseInt(minInput.value) || 1;
                slider.valueEnd = parseInt(maxInput.value) || 100;
                minValue.textContent = slider.valueStart;
                maxValue.textContent = slider.valueEnd;
            }

            // Update on user interaction
            slider.addEventListener('input', function()
            {
                // Start slider value
                const startValue = slider.valueStart;

                // End slider value
                const endValue = slider.valueEnd;

                minValue.textContent = startValue;
                maxValue.textContent = endValue;

                if (minInput)
                {
                    minInput.value = startValue;
                }

                if (maxInput)
                {
                    maxInput.value = endValue;
                }
            });
        });
    }

    /// <summary>
    /// On DOMContentLoaded, open sidebar if requested and initialize sliders.
    /// </summary>
    document.addEventListener('DOMContentLoaded', function()
    {
        // URL parameters
        const params = new URLSearchParams(window.location.search);

        if (params.get('sidebar') === 'open')
        {
            openFilterSidebar();
        }

        setupSliders();
    });

    // On form submit, update hidden slider input fields
    document.getElementById('filterForm')?.addEventListener('submit', function(e) {

        // Slider components in Filter sidebar
        var sliders = document.querySelectorAll('md-slider');

        sliders.forEach(function(slider)
        {
            // The name of the statistic, as defined in the slider’s data-stat attribute
            const statName = slider.getAttribute('data-stat');

            // The hidden input field used to store the slider’s minimum value on form submit
            const minInput = document.getElementById(`${statName}Min`);

            // The hidden input field used to store the slider’s maximum value on form submit
            const maxInput = document.getElementById(`${statName}Max`);

            if (minInput && maxInput)
            {
                minInput.value = slider.valueStart;
                maxInput.value = slider.valueEnd;
            }
        });
    });
</script>