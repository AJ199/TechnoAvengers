@page
@using ContosoCrafts.WebSite.Components
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}

<div class="header-container">

    <form method="get" id="searchForm" class="search-bar-container">
        <input type="text" name="SearchTerm" placeholder="Search by name..."
               value="@Request.Query["SearchTerm"]"
               class="search-input" />

        <!-- Sort field selection -->
        <select name="SortField" class="sort-dropdown">
            <option value="Title" selected="@("Title" == Request.Query["SortField"])">Sort by Name</option>
            <option value="Intelligence" selected="@("Intelligence" == Request.Query["SortField"])">Sort by Intelligence</option>
            <option value="Strength" selected="@("Strength" == Request.Query["SortField"])">Sort by Strength</option>
            <option value="Speed" selected="@("Speed" == Request.Query["SortField"])">Sort by Speed</option>
            <option value="Durability" selected="@("Durability" == Request.Query["SortField"])">Sort by Durability</option>
            <option value="Power" selected="@("Power" == Request.Query["SortField"])">Sort by Power</option>
            <option value="Combat" selected="@("Combat" == Request.Query["SortField"])">Sort by Combat</option>
        </select>

        <!-- Hidden input used by toggle button -->
        <input type="hidden" name="SortOrder" id="SortOrderInput" value="@(Request.Query["SortOrder"].ToString() ?? "asc")" />

        <!-- Toggle button for sort order -->
        <button type="button" class="btn-sort-toggle" onclick="toggleSortOrder()">
            @(Request.Query["SortOrder"] == "desc" ? "▼ Descending" : "▲ Ascending")
        </button>

        <script>
            function toggleSortOrder() {
                const input = document.getElementById('SortOrderInput');
                input.value = input.value === 'asc' ? 'desc' : 'asc';
                document.getElementById('searchForm').submit();
            }
        </script>

        <button type="submit" class="btn btn-terciary">Search</button>
        <button type="button" class="btn btn-terciary" onclick="openFilterSidebar()">Filter</button>
        <button type="button" class="btn btn-secondary" onclick="clearAll()">Clear All</button>

        @foreach (var category in new[] { "Alignment", "Role", "Gender" })
        {
            foreach (var value in Request.Query[category])
            {
                <input type="hidden" name="@category" value="@value" />
            }
        }

        @foreach (var stat in new[] { "Intelligence", "Strength", "Speed", "Durability", "Power", "Combat" })
        {
            <input type="hidden" name="@($"{stat}Min")" value="@Request.Query[$"{stat}Min"].FirstOrDefault() ?? " 1"" />
            <input type="hidden" name="@($"{stat}Max")" value="@Request.Query[$"{stat}Max"].FirstOrDefault() ?? " 100"" />
        }
    </form>
</div>

<!-- Display number of superheroes found -->
@if (Request.Query.Count > 0)
{
    if (Model.FilteredHeroes.Count == 1)
    {
        <p class="hero-text hero-subtext">
            <span class="numbers">@Model.FilteredHeroes.Count</span> superhero found
        </p>
    }

    else if (Model.FilteredHeroes.Count > 1)
    {
        <p class="hero-text hero-subtext">
            <span class="numbers">@Model.FilteredHeroes.Count superheroes found</span>
        </p>
    }
    else
    {
        <p class="hero-text hero-subtext">No superheroes match the selected filters</p>
    }
}

<!-- Display filtered superheroes using Blazor component -->
@(await Html.RenderComponentAsync<ProductList>(RenderMode.ServerPrerendered, new { Products = Model.FilteredHeroes }))

<!-- Sidebar filter menu (hidden by default) -->
<div id="filterSidebar" class="sidebar">
    <div class="sidebar-header">
        <h4>Filter by:</h4>
        <span class="close-btn" onclick="closeSidebar()">×</span>
    </div>

    <!-- Filter form -->
    <div class="sidebar-content">
        <form method="get" id="filterForm">
            @foreach (var category in new[] { "Alignment", "Role", "Gender" })
            {
                <div class="filter-group">
                    <strong>@category</strong>
                    <div class="filter-options">
                        @foreach (var value in Model.GetValuesForCategory(category))
                        {
                            <label>
                                <input type="checkbox" name="@category" value="@value"
                                @(Request.Query[category].Contains(value) ? "checked" : "") />
                                @value
                            </label>
                        }
                    </div>
                </div>
            }

            <!-- Powerstats sliders -->
            <div class="filter-group">
                <strong>Powerstats</strong>
                @foreach (var stat in new[] { "Intelligence", "Strength", "Speed", "Durability", "Power", "Combat" })
                {
                    <div class="stat-slider">
                        <label>@stat: </label>
                        <span class="slider-values min-value">@(Request.Query[$"{stat}Min"].FirstOrDefault() ?? "1")</span>
                        <span> - </span>
                        <span class="slider-values max-value">@(Request.Query[$"{stat}Max"].FirstOrDefault() ?? "100")</span>
                        <div class="slider-container">
                            <md-slider min="1"
                                       max="100"
                                       value-start="@Request.Query[$"{stat}Min"].FirstOrDefault() ?? " 1""
                                       value-end="@Request.Query[$"{stat}Max"].FirstOrDefault() ?? " 100""
                                       data-stat="@stat"
                                       labeled
                                       range>
                            </md-slider>
                            <input type="hidden" name="@(stat)Min" id="@(stat)Min" value="@(Request.Query[$"{stat}Min"].FirstOrDefault() ?? "1")" />
                            <input type="hidden" name="@(stat)Max" id="@(stat)Max" value="@(Request.Query[$"{stat}Max"].FirstOrDefault() ?? "100")" />
                        </div>
                    </div>
                }
            </div>

            <input type="hidden" name="SearchTerm" value="@Request.Query["SearchTerm"]" />
            <button type="submit" class="btn btn-filter-confirm">Apply Filter</button>
            <button type="button" class="btn btn-filter-clear" onclick="clearFilter()">Clear Filters</button>
        </form>
    </div>
</div>


<script src="_framework/blazor.server.js"></script>
<script>
    // Open the filter sidebar panel
    function openFilterSidebar()
    {
        document.getElementById("filterSidebar").classList.add("show");
        setupSliders();
    }

    // Close the filter sidebar panel
    function closeSidebar()
    {
        document.getElementById("filterSidebar").classList.remove("show");
    }

    // Reset all filters and reload the form
    function clearFilter()
    {   
        // Unchecks the filers
        document.querySelectorAll('input[type="checkbox"]').forEach(function(cb)
        {
            cb.checked = false;
        });

        // Slider components in Filter sidebar
        var sliders = document.querySelectorAll('md-slider');
        sliders.forEach(function(slider) 
        {
            slider.valueStart = 1;
            slider.valueEnd = 100;

            const statName = slider.getAttribute('data-stat');
            const container = slider.closest('.stat-slider');
            const minValue = container.querySelector('.min-value');
            const maxValue = container.querySelector('.max-value');
            const minInput = document.getElementById(`${statName}Min`);
            const maxInput = document.getElementById(`${statName}Max`);

            minValue.textContent = '1';
            maxValue.textContent = '100';

            if (minInput) minInput.value = '1';
            if (maxInput) maxInput.value = '100';
        });

        document.getElementById('filterForm').submit();
    }

     // Clears search input and resets all filters
    function clearAll()
    {
        document.querySelector('input[name="SearchTerm"]').value = '';

        // Unchecks the filters
        document.querySelectorAll('input[type="checkbox"]').forEach(function(cb)
        {
            cb.checked = false;
        });

        // Slider components in Filter sidebar
        var sliders = document.querySelectorAll('md-slider');
        sliders.forEach(function(slider)
        {
            slider.valueStart = 1;
            slider.valueEnd = 100;

            const statName = slider.getAttribute('data-stat');
            const container = slider.closest('.stat-slider');
            const minValue = container.querySelector('.min-value');
            const maxValue = container.querySelector('.max-value');
            const minInput = document.getElementById(`${statName}Min`);
            const maxInput = document.getElementById(`${statName}Max`);

            minValue.textContent = '1';
            maxValue.textContent = '100';

            if (minInput) minInput.value = '1';
            if (maxInput) maxInput.value = '100';
        });

        window.location.href = window.location.pathname;
    }


    // Configure slider positions and listeners
    function setupSliders()
    {
        // Slider components in Filter sidebar
        var sliders = document.querySelectorAll('md-slider');

        sliders.forEach(function(slider)
        {
            const statName = slider.getAttribute('data-stat');
            const container = slider.closest('.stat-slider');
            const minValue = container.querySelector('.min-value');
            const maxValue = container.querySelector('.max-value');

            const minInput = document.getElementById(`${statName}Min`);
            const maxInput = document.getElementById(`${statName}Max`);

            if (minInput && maxInput)
            {
                slider.valueStart = parseInt(minInput.value) || 1;
                slider.valueEnd = parseInt(maxInput.value) || 100;
                minValue.textContent = slider.valueStart;
                maxValue.textContent = slider.valueEnd;
            }

            slider.addEventListener('change', function() 
            {
                const startValue = slider.valueStart;
                const endValue = slider.valueEnd;

                minValue.textContent = startValue;
                maxValue.textContent = endValue;

                if (minInput) 
                {
                    minInput.value = startValue;
                }

                if (maxInput) 
                {
                    maxInput.value = endValue;
                }
            });
        });
    }

    // Run on page load: initialize sliders and check sidebar param
    document.addEventListener('DOMContentLoaded', function() 
    {
        // URL parameters
        const params = new URLSearchParams(window.location.search);

        if (params.get('sidebar') === 'open')
        {
            openFilterSidebar();
        }

        setupSliders();
    });

    // On form submit, update hidden slider input fields
    document.getElementById('filterForm')?.addEventListener('submit', function(e) {
        
        // Slider components in Filter sidebar
        var sliders = document.querySelectorAll('md-slider');

        sliders.forEach(function(slider)
        {
            const statName = slider.getAttribute('data-stat');
            const minInput = document.getElementById(`${statName}Min`);
            const maxInput = document.getElementById(`${statName}Max`);

            if (minInput && maxInput)
            {
                minInput.value = slider.valueStart;
                maxInput.value = slider.valueEnd;
            }
        });
    });
</script>
